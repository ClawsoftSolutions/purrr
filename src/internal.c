#include "./internal.h"

#include <stdlib.h>
#include <string.h>

void *_purrr_malloc_with_header(_Purrr_Object_Header header, size_t size) {
  _Purrr_Object_Header *ptr = malloc(sizeof(_Purrr_Object_Header) + size);
  if (!ptr) return ptr;
  memcpy(ptr, &header, sizeof(header));
  return &ptr[1]; // I think I saw that trick while watching a Tsoding session when he went deepah into stb_ds' hash maps, I forgot what the stream was about tho
}

_Purrr_Object_Header _purrr_get_header(void *ptr) {
  if (!ptr) return (_Purrr_Object_Header){
    .backend = COUNT_PURRR_BACKENDS,
    .type = COUNT_PURRR_BACKENDS
  };
  return ((_Purrr_Object_Header*)ptr)[-1];
}

void _purrr_free_with_header(void *ptr) {
  if (ptr) free(&((_Purrr_Object_Header*)ptr)[-1]);
}



uint32_t _purrr_formats_channel_count[COUNT_PURRR_FORMATS] = {
  [PURRR_R8_UNORM] = 1,
  [PURRR_R8_SNORM] = 1,
  [PURRR_R8_UINT] = 1,
  [PURRR_R8_SINT] = 1,
  [PURRR_R8_SRGB] = 1,
  [PURRR_R8G8_UNORM] = 2,
  [PURRR_R8G8_SNORM] = 2,
  [PURRR_R8G8_UINT] = 2,
  [PURRR_R8G8_SINT] = 2,
  [PURRR_R8G8_SRGB] = 2,
  [PURRR_R8G8B8_UNORM] = 3,
  [PURRR_R8G8B8_SNORM] = 3,
  [PURRR_R8G8B8_UINT] = 3,
  [PURRR_R8G8B8_SINT] = 3,
  [PURRR_R8G8B8_SRGB] = 3,
  [PURRR_B8G8R8_UNORM] = 3,
  [PURRR_B8G8R8_SNORM] = 3,
  [PURRR_B8G8R8_UINT] = 3,
  [PURRR_B8G8R8_SINT] = 3,
  [PURRR_B8G8R8_SRGB] = 3,
  [PURRR_R8G8B8A8_UNORM] = 4,
  [PURRR_R8G8B8A8_SNORM] = 4,
  [PURRR_R8G8B8A8_UINT] = 4,
  [PURRR_R8G8B8A8_SINT] = 4,
  [PURRR_R8G8B8A8_SRGB] = 4,
  [PURRR_B8G8R8A8_UNORM] = 4,
  [PURRR_B8G8R8A8_SNORM] = 4,
  [PURRR_B8G8R8A8_UINT] = 4,
  [PURRR_B8G8R8A8_SINT] = 4,
  [PURRR_B8G8R8A8_SRGB] = 4,
  [PURRR_R16_UNORM] = 1,
  [PURRR_R16_SNORM] = 1,
  [PURRR_R16_UINT] = 1,
  [PURRR_R16_SINT] = 1,
  [PURRR_R16_SFLOAT] = 1,
  [PURRR_R16G16_UNORM] = 2,
  [PURRR_R16G16_SNORM] = 2,
  [PURRR_R16G16_UINT] = 2,
  [PURRR_R16G16_SINT] = 2,
  [PURRR_R16G16_SFLOAT] = 2,
  [PURRR_R16G16B16_UNORM] = 3,
  [PURRR_R16G16B16_SNORM] = 3,
  [PURRR_R16G16B16_UINT] = 3,
  [PURRR_R16G16B16_SINT] = 3,
  [PURRR_R16G16B16_SFLOAT] = 3,
  [PURRR_R16G16B16A16_UNORM] = 4,
  [PURRR_R16G16B16A16_SNORM] = 4,
  [PURRR_R16G16B16A16_UINT] = 4,
  [PURRR_R16G16B16A16_SINT] = 4,
  [PURRR_R16G16B16A16_SFLOAT] = 4,
  [PURRR_R32_UINT] = 1,
  [PURRR_R32_SINT] = 1,
  [PURRR_R32_SFLOAT] = 1,
  [PURRR_R32G32_UINT] = 2,
  [PURRR_R32G32_SINT] = 2,
  [PURRR_R32G32_SFLOAT] = 2,
  [PURRR_R32G32B32_UINT] = 3,
  [PURRR_R32G32B32_SINT] = 3,
  [PURRR_R32G32B32_SFLOAT] = 3,
  [PURRR_R32G32B32A32_UINT] = 4,
  [PURRR_R32G32B32A32_SINT] = 4,
  [PURRR_R32G32B32A32_SFLOAT] = 4,
  [PURRR_R64_UINT] = 1,
  [PURRR_R64_SINT] = 1,
  [PURRR_R64_SFLOAT] = 1,
  [PURRR_R64G64_UINT] = 2,
  [PURRR_R64G64_SINT] = 2,
  [PURRR_R64G64_SFLOAT] = 2,
  [PURRR_R64G64B64_UINT] = 3,
  [PURRR_R64G64B64_SINT] = 3,
  [PURRR_R64G64B64_SFLOAT] = 3,
  [PURRR_R64G64B64A64_UINT] = 4,
  [PURRR_R64G64B64A64_SINT] = 4,
  [PURRR_R64G64B64A64_SFLOAT] = 4
};

uint32_t _purrr_formats_size[COUNT_PURRR_FORMATS] = {
  [PURRR_R8_UNORM] = 1,
  [PURRR_R8_SNORM] = 1,
  [PURRR_R8_UINT] = 1,
  [PURRR_R8_SINT] = 1,
  [PURRR_R8_SRGB] = 1,
  [PURRR_R8G8_UNORM] = 1,
  [PURRR_R8G8_SNORM] = 1,
  [PURRR_R8G8_UINT] = 1,
  [PURRR_R8G8_SINT] = 1,
  [PURRR_R8G8_SRGB] = 1,
  [PURRR_R8G8B8_UNORM] = 1,
  [PURRR_R8G8B8_SNORM] = 1,
  [PURRR_R8G8B8_UINT] = 1,
  [PURRR_R8G8B8_SINT] = 1,
  [PURRR_R8G8B8_SRGB] = 1,
  [PURRR_B8G8R8_UNORM] = 1,
  [PURRR_B8G8R8_SNORM] = 1,
  [PURRR_B8G8R8_UINT] = 1,
  [PURRR_B8G8R8_SINT] = 1,
  [PURRR_B8G8R8_SRGB] = 1,
  [PURRR_R8G8B8A8_UNORM] = 1,
  [PURRR_R8G8B8A8_SNORM] = 1,
  [PURRR_R8G8B8A8_UINT] = 1,
  [PURRR_R8G8B8A8_SINT] = 1,
  [PURRR_R8G8B8A8_SRGB] = 1,
  [PURRR_B8G8R8A8_UNORM] = 1,
  [PURRR_B8G8R8A8_SNORM] = 1,
  [PURRR_B8G8R8A8_UINT] = 1,
  [PURRR_B8G8R8A8_SINT] = 1,
  [PURRR_B8G8R8A8_SRGB] = 1,
  [PURRR_R16_UNORM] = 2,
  [PURRR_R16_SNORM] = 2,
  [PURRR_R16_UINT] = 2,
  [PURRR_R16_SINT] = 2,
  [PURRR_R16_SFLOAT] = 2,
  [PURRR_R16G16_UNORM] = 2,
  [PURRR_R16G16_SNORM] = 2,
  [PURRR_R16G16_UINT] = 2,
  [PURRR_R16G16_SINT] = 2,
  [PURRR_R16G16_SFLOAT] = 2,
  [PURRR_R16G16B16_UNORM] = 2,
  [PURRR_R16G16B16_SNORM] = 2,
  [PURRR_R16G16B16_UINT] = 2,
  [PURRR_R16G16B16_SINT] = 2,
  [PURRR_R16G16B16_SFLOAT] = 2,
  [PURRR_R16G16B16A16_UNORM] = 2,
  [PURRR_R16G16B16A16_SNORM] = 2,
  [PURRR_R16G16B16A16_UINT] = 2,
  [PURRR_R16G16B16A16_SINT] = 2,
  [PURRR_R16G16B16A16_SFLOAT] = 2,
  [PURRR_R32_UINT] = 4,
  [PURRR_R32_SINT] = 4,
  [PURRR_R32_SFLOAT] = 4,
  [PURRR_R32G32_UINT] = 4,
  [PURRR_R32G32_SINT] = 4,
  [PURRR_R32G32_SFLOAT] = 4,
  [PURRR_R32G32B32_UINT] = 4,
  [PURRR_R32G32B32_SINT] = 4,
  [PURRR_R32G32B32_SFLOAT] = 4,
  [PURRR_R32G32B32A32_UINT] = 4,
  [PURRR_R32G32B32A32_SINT] = 4,
  [PURRR_R32G32B32A32_SFLOAT] = 4,
  [PURRR_R64_UINT] = 8,
  [PURRR_R64_SINT] = 8,
  [PURRR_R64_SFLOAT] = 8,
  [PURRR_R64G64_UINT] = 8,
  [PURRR_R64G64_SINT] = 8,
  [PURRR_R64G64_SFLOAT] = 8,
  [PURRR_R64G64B64_UINT] = 8,
  [PURRR_R64G64B64_SINT] = 8,
  [PURRR_R64G64B64_SFLOAT] = 8,
  [PURRR_R64G64B64A64_UINT] = 8,
  [PURRR_R64G64B64A64_SINT] = 8,
  [PURRR_R64G64B64A64_SFLOAT] = 8
};